name: Lint and Test

on:
  pull_request:
    paths:
      - 'charts/**'
  push:
    branches:
      - main
    paths:
      - 'charts/**'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Lint all charts
        run: |
          for chart in charts/library/* charts/apps/*; do
            if [[ -f "$chart/Chart.yaml" ]]; then
              echo "Updating dependencies for $chart"
              helm dependency update "$chart"
              echo "Linting $chart"
              helm lint "$chart"
            fi
          done

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Template test
        run: |
          for chart in charts/library/* charts/apps/*; do
            if [[ -f "$chart/Chart.yaml" ]]; then
              # Skip library charts (they can't be templated directly)
              chart_type=$(grep "^type:" "$chart/Chart.yaml" | awk '{print $2}')
              if [[ "$chart_type" == "library" ]]; then
                echo "Skipping library chart: $chart"
                continue
              fi
              echo "Updating dependencies for $chart"
              helm dependency update "$chart"
              echo "Testing templates for $chart"
              helm template test-release "$chart" > /dev/null
            fi
          done
